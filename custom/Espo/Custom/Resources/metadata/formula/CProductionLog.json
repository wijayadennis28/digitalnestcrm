{
    "beforeSaveCustomScript": "// Generate Batch Code\nbatchCode=string\\concatenate(product.sku, batch, producedAt, shift, cFormula.name);\n\n// Calculate amount of product produced\n$productIdsFromFormula = list();\n$ingredientsFromFormula = object\\create();\n$ingredientsFromInput = object\\create();\n\n$i = 0;\nwhile ($i < array\\length(cFormula.cIngredientsAmountsIds)) {\n    $id = array\\at(cFormula.cIngredientsAmountsIds, $i);\n    $ingredientAmount = record\\fetch('CIngredientsAmount', $id);\n    $productId = object\\get($ingredientAmount, 'productId');\n    $produtAmount = object\\get($ingredientAmount, 'amount');\n    $productIdsFromFormula = array\\push($productIdsFromFormula, $productId);\n    object\\set($ingredientsFromFormula, $productId, $produtAmount);\n    $i = $i + 1;\n}\n\n$i = 0;\nwhile ($i < array\\length(cIngredientsAmountsIds)) {\n    $id = array\\at(cIngredientsAmountsIds, $i);\n    $ingredientAmount = record\\fetch('CIngredientsAmount', $id);\n    $productId = object\\get($ingredientAmount, 'productId');\n    $produtAmount = object\\get($ingredientAmount, 'amount');\n    object\\set($ingredientsFromInput, $productId, $produtAmount);\n    $i = $i + 1;\n}\n\n$isInputComplete = true;\n$producedAmount = 999999;\n\n$i = 0;\nwhile ($i < array\\length($productIdsFromFormula)) {\n    $productId = array\\at($productIdsFromFormula, $i);\n    if (!object\\has($ingredientsFromInput, $productId)) {\n        $isInputComplete = false;\n        break;\n    }\n    $amountFromFormula = object\\get($ingredientsFromFormula, $productId);\n    $amountFromInput = object\\get($ingredientsFromInput, $productId);\n    $currentAmountProduced = number\\floor($amountFromInput/$amountFromFormula);\n    if ($currentAmountProduced < $producedAmount) {\n        $producedAmount = $currentAmountProduced;\n    }\n    $i = $i + 1;\n}\n\nif ($isInputComplete) {\n    if (productionStatus == 'Successful') {\n        total = $producedAmount;\n    } else {\n        total = $producedAmount - totalRecycledProduct;\n    }\n}"
}