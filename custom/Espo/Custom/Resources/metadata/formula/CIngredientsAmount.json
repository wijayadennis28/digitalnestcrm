{
    "beforeSaveCustomScript": "// Calculate amount of product produced\n$productIdsFromFormula = list();\n$ingredientsFromFormula = object\\create();\n$ingredientsFromInput = object\\create();\n\n$productionLog = record\\fetch('CProductionLog', cProductionLogId);\n$formulaId = object\\get($productionLog, 'cProductFormulaId');\n$formula = record\\fetch('CProductFormula', $formulaId);\n$productionLogJson = json\\encode($productionLog);\n\n// Get expected ingredients and amount from formula\n$i = 0;\n$formulaListIds = object\\get($formula, 'cProductFormulaListsIds');\nwhile ($i < array\\length($formulaListIds)) {\n    $id = array\\at($formulaListIds, $i);\n    $formulaList = record\\fetch('CProductFormulaList', $id);\n    $productId = object\\get($formulaList, 'productId');\n    $productAmount = object\\get($formulaList, 'quantity');\n    $productIdsFromFormula = array\\push($productIdsFromFormula, $productId);\n    object\\set($ingredientsFromFormula, $productId, $productAmount);\n    $i = $i + 1;\n}\n\n// Get ingredients and amount from production log\n$i = 0;\n$ingredientsAmountIds = object\\get($productionLog, 'cIngredientsAmountsIds');\nwhile ($i < array\\length($ingredientsAmountIds)) {\n    $id = array\\at($ingredientsAmountIds, $i);\n    $ingredientAmount = record\\fetch('CIngredientsAmount', $id);\n    $productId = object\\get($ingredientAmount, 'productId');\n    $productAmount = object\\get($ingredientAmount, 'amount');\n    object\\set($ingredientsFromInput, $productId, $productAmount);\n    $i = $i + 1;\n}\n\nobject\\set($ingredientsFromInput, productId, amount);\n\n$isInputComplete = true;\n$producedAmount = 999999;\n\n$i = 0;\nwhile ($i < array\\length($productIdsFromFormula)) {\n    $productId = array\\at($productIdsFromFormula, $i);\n    if (!object\\has($ingredientsFromInput, $productId)) {\n        $isInputComplete = false;\n        break;\n    }\n    $amountFromFormula = object\\get($ingredientsFromFormula, $productId);\n    $amountFromInput = object\\get($ingredientsFromInput, $productId);\n    $currentAmountProduced = number\\floor($amountFromInput/$amountFromFormula);\n    if ($currentAmountProduced < $producedAmount) {\n        $producedAmount = $currentAmountProduced;\n    }\n    $i = $i + 1;\n}\n\nif ($isInputComplete) {\n    // If production status is Failed, subtract amount produced with recycled product amount\n    if (object\\get($productionLog, 'productionStatus') == 'Failed') {\n        $totalRecycledProduct = object\\get($productionLog, 'totalRecycledProduct');\n        $producedAmount = $producedAmount - $totalRecycledProduct;\n    }\n} else {\n    $producedAmount = 0;\n}\n\n// Update amount produced on Production Log\nrecord\\update('CProductionLog', cProductionLogId, 'total', $producedAmount);\n\n// Create/update Inventory Transaction for ingredients based on formula\n$i = 0;\nwhile ($i < array\\length($productIdsFromFormula)) {\n    $productId = array\\at($productIdsFromFormula, $i);\n    $amount =ifThenElse(\n        object\\has($ingredientsFromInput, $productId) && $isInputComplete,\n        0 - object\\get($ingredientsFromInput, $productId),\n        0\n    );\n    $transactionExist = record\\exists('InventoryTransaction', 'productionLogId=', cProductionLogId, 'productId=', $productId);\n    if ($transactionExist) {\n        $inventoryTransactionId = record\\findOne('InventoryTransaction', 'createdAt', 'desc', 'productionLogId=', cProductionLogId, 'productId=', $productId);\n        record\\update('InventoryTransaction', $inventoryTransactionId,\n            'quantity', $amount,\n        );\n    } else {\n        $warehouseId = object\\get($productionLog, 'warehouseId');\n        record\\create('InventoryTransaction',\n            'type', 'Transfer',\n            'quantity', $amount,\n            'productId', $productId,\n            'warehouseId', $warehouseId,\n            'productionLogId', cProductionLogId,\n        );\n    }\n    $i = $i + 1;\n}"
}